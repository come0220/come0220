/**
 * jQuery SmartPage v0.1.0 - page smart change plugin
 *
 * Terms of Use - jQuery SmartPage
 * under the MIT (http://www.opensource.org/licenses/mit-license.php) License.
 *
 * Copyright 2011 xlune.com All rights reserved.
 * (http://blog.xlune.com/2011/05/jquerysmartpage.html)
 */
(function(e){e.fn.smartPage=function(h){var o={endPoint:location.protocol+"//"+location.hostname+"/",fixedEndPoint:!1,fragment:"#!",useFade:!1,useCSSFade:!1,useScrollTop:!1,useHash:!1,useHistoryState:!1,useIE9:!1,useFragmentClear:!0,onStart:null,onChange:null,onComplete:null,onScriptComplete:null,onError:null,pageRules:[],baseList:[],insertList:[],scriptDelay:100},p={isInit_:!1,state_:null,hash_:null,hashTimer_:null,deferred_:null,task_:[]},n={CANCEL:"cancel"},b={},i={init:function(a){var d=this;
b=e.extend({},o,a,p);if(c.isNotIE()||b.useIE9&&c.getIEVersion()>=9){if(typeof history.pushState!=="function")b.useHistoryState=!1;b.fixedEndPoint&&b.useHash&&!b.useHistoryState&&c.checkPath(c.getUrl())&&(a=c.getPathName(c.getUrl()),c.getUrl().replace(/#.*$/gi,"")!==b.endPoint&&location.replace(b.endPoint+b.fragment+a));if(b.useHash||b.useHistoryState){if(b.useHistoryState)b.state_=location.href,c.setStateChangeEvent(),b.useFragmentClear&&c.replaceClearHash();else{if(!b.fragment.match(/^#/))b.fragment=
"#"+b.fragment;c.setHashChangeEvent();c.hashChangeHandler()}e(function(){c.setClickEvents(d)})}}else b.useFragmentClear&&c.replaceClearHash();return d.each(function(){e(d)})},getUrl:function(){if(b.useHistoryState)return[location.protocol,"//",location.hostname,location.pathname,encodeURI(location.search).replace(/'/g,"%27"),encodeURI(location.hash).replace(/'/g,"%27")].join("");else{var a=RegExp(b.fragment+"/?");return(c.getBasePoint()+b.hash_).replace(a,"")}}},c={setClickEvents:function(a){e(a).find("a, area").live("click",
c.clickHandler)},clickHandler:function(a){var d=e(a.target).attr("href");if(d&&(d=c.getFullPath(d),c.checkPath(d)))return b.useHistoryState?d!==b.state_&&(history.pushState({},c.getTitle(),d),c.load(d)):(d=c.getPathName(d),location.hash=b.fragment+d),a.preventDefault(),!1;return!0},getTitle:function(){return document.title},getUrl:function(){return c.escapeHtmlSpecialCharacters(location.href)},getFullPath:function(a){var b=c.getUrl().replace(/[#?].*$/gi,"").replace(/\/[^\/]*$/,"/");switch(!0){case /^https?:\/\//.test(a):break;
case /^\//.test(a):a=location.protocol+"//"+location.hostname+a;break;default:for(;;)if(/^.\//.test(a))a=a.replace(/^.\//,"");else if(/^..\//.test(a))a=a.replace(/^..\//,""),b.match(/\//g).length>3&&(b=b.replace(/[^\/]*\/$/,""));else{a=b+a;break}}return a},checkPath:function(a){if(b.pageRules instanceof Array){var d,f=b.pageRules.concat();if(!f.length){var g=c.escapeRegExpSpecialCharacters(b.endPoint);f.push(RegExp("^"+g,"i"))}for(d in f)if(!(f[d][0]instanceof RegExp&&f[d][0].test(a)===f[d][1]))return!1;
return!0}return!1},getPathName:function(a){return a.replace(c.getBasePoint(),"")},getHashKey:function(){return location.hash.replace(RegExp("^"+b.fragment),"")},getBasePoint:function(){return b.endPoint.replace(/\/$/,"")},isNotIE:function(){return/*@cc_on!@*/true},getIEVersion:function(){for(var a=3,b=document.createElement("div"),c=b.getElementsByTagName("i");b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>",c[0];);return a>4?a:null},replaceClearHash:function(){var a=RegExp(b.fragment+"/?","g");a.test(location.href)&&
(b.useHistoryState?(a=location.href.replace(a,""),history.replaceState({},null,a),c.load(a)):location.replace(location.href.replace(a,"")))},load:function(a){b.state_=a;b.isInit_=!0;b.deferred_&&b.deferred_.abort(n.CANCEL);if(typeof b.onStart==="function")b.onStart();b.deferred_=e.get(a).then(c.loadComplete,c.loadError)},loadCompleteTask:function(){if(b.task_.length>0)b.task_.shift()();else if(typeof b.onScriptComplete==="function")b.onScriptComplete()},loadCompleteChange:function(){if(typeof b.onChange===
"function")b.onChange()},loadCompleteFinish:function(){if(typeof b.onComplete==="function")b.onComplete();c.loadCompleteTask();b.useScrollTop&&c.scrollTop()},loadError:function(a,d){if(d!==n.CANCEL&&(e.error("page load error"),typeof b.onError==="function"))b.onError()},loadComplete:function(a){var d,f,g,m,j,k,h=b.baseList,l=b.insertList;d=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;var i=a.match(d);f=function(a){return function(){return"<\!--%%smartpage-script"+(a++).toString()+"%%--\>"}}(0);
var n=document.write,o=document.writeln;b.task_=[];var p=e("<div />").append(a.replace(d,f));if(h instanceof Array){d=0;for(f=Math.min(h.length,l.length);d<f;d++){j=e(h[d]);l[d]?(g=p.find(l[d]),g.each(function(a){var b;if(a=e(j.get(a)))for(b in this.attributes)a.attr(this.attributes[b].nodeName,this.attributes[b].nodeValue)}),k=g.html()):k=a;g=0;for(m=i.length;g<m;g++)k.match("<\!--%%smartpage-script"+g+"%%--\>")&&(k=k.replace("<\!--%%smartpage-script"+g+"%%--\>",'<div id="smartpage-script'+g.toString()+
'" style="position: static !important; border:none !important; margin:0 !important; padding:0 !important; background:none !important;"> </div>'),b.task_.push(function(a,d,g){return function(){var d=e("#"+a);if(d.size()>0){var f,h=b.scriptDelay,j=e(g),m,k=!1,i=function(){if(!k)document.write=n,document.writeln=o,c.loadCompleteTask()},l=function(){k&&(k=!1,clearTimeout(f),f=setTimeout(i,h))};document.write=function(a){d.get(0).innerHTML+=a;clearTimeout(f);f=setTimeout(i,h)};document.writeln=function(a){a+=
"\r\n";d.get(0).innerHTML+=a;clearTimeout(f);f=setTimeout(i,h)};(m=j.attr("src"))?(k=!0,j=document.createElement("script"),j.src=m,j.onload=l,j.onreadystatechange=function(){(this.readyState=="loaded"||this.readyState=="complete")&&l()},d.get(0).appendChild(j)):(clearTimeout(f),f=setTimeout(i,h),d.html(j))}else c.loadCompleteTask()}}("smartpage-script"+g.toString(),g,i[g])));c.setFadeAction(j,k,d)}}},setCSSFade:function(a,b,c){b=isNaN(b)?0:b;c=isNaN(c)?0:c;a.css({"-webkit-transition-property":"opacity",
"-webkit-transition-duration":c.toString()+"s","-webkit-transition-timing-function":"ease-out","-moz-transition-property":"opacity","-moz-transition-duration":c.toString()+"s","-moz-transition-timing-function":"ease-out","transition-property":"opacity","transition-duration":c.toString()+"s","transition-timing-function":"ease-out",opacity:b})},setFadeAction:function(a,d,f){b.useCSSFade&&(typeof e("html").css("-webkit-transition-property")!=="undefined"||typeof e("html").css("-moz-transition-property")!==
"undefined"||typeof e("html").css("transition-property")!=="undefined")?(clearTimeout(a.data("smartpage-timer")),c.setCSSFade(a,0,0.3),a.data("smartpage-timer",setTimeout(function(a,b,d){return function(){a.html(b);d==0&&c.loadCompleteChange();clearTimeout(a.data("smartpage-timer"));c.setCSSFade(a,1,0.3);a.data("smartpage-timer",setTimeout(function(a,b,d){return function(){d==0&&c.loadCompleteFinish()}}(a,b,d),300))}}(a,d,f),300))):a.stop().fadeTo(b.useFade?300:1,0.01,function(a,b,d){return function(){a.html(b);
d==0&&c.loadCompleteChange()}}(a,d,f)).fadeTo(b.useFade?300:1,1,function(a){return function(){a==0&&c.loadCompleteFinish()}}(f))},scrollTop:function(){var a=e(window);e("head").stop().css({position:"fixed",top:a.scrollTop()+"px"}).animate({top:0},{duration:500,easing:"linear",step:function(b){a.scrollTop(b)}})},setStateChangeEvent:function(){e(window).unbind("popstate",c.stateChangeHandler);e(window).bind("popstate",c.stateChangeHandler)},stateChangeHandler:function(){b.isInit_&&c.load(location.href);
b.isInit_=!0},setHashChangeEvent:function(){"onhashchange"in window?(e(window).unbind("hashchange",c.hashChangeHandler),e(window).bind("hashchange",c.hashChangeHandler)):(clearInterval(b.hashTimer_),b.hashTimer_=setInterval(function(a){return function(){c.hashChangeHandler.apply(a)}}(this),500))},hashChangeHandler:function(){var a;if(b.hash_!==(a=c.getHashKey()))b.hash_=a,b.isInit_&&c.load(c.getBasePoint()+a),b.isInit_=!0},escapeRegExpSpecialCharacters:function(a){return a.replace(/(\\|\/|\^|\$|\*|\+|\?|\{|\||\}|\[|\])/g,
"\\$1")},escapeHtmlSpecialCharacters:function(a){var b,c,e=[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"],[/"/g,"&quot;"],[/'/g,"&#039;"]];b=0;for(c=e.length;b<c;b++)a=a.replace(e[b][0],e[b][1]);return a},delay:function(a){a=isNaN(a)?0:a;return e.Deferred(function(b){setTimeout(b.resolve,a*1E3)}).promise()}};if(i[h])return i[h].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof h==="object"||!h)return i.init.apply(this,arguments);else e.error('Method "'+h+'" does not exist in smartPage plugin!')}})(jQuery);



